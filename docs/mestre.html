<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel do Mestre</title>
  <link rel="stylesheet" href="CSS/style.css" />
  <style>
    /* Estilos específicos do Painel do Mestre */
    body { background-color: #0a0a0a; color: white; font-family: Arial, sans-serif; }
    
    .grid-personagens {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        padding: 40px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .card-personagem {
        background: #1a1a1a;
        border: 1px solid #333;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: transform 0.2s, border-color 0.2s;
        position: relative;
        overflow: hidden;
    }

    .card-personagem:hover {
        transform: translateY(-5px);
        border-color: #9c27b0;
        box-shadow: 0 4px 15px rgba(156, 39, 176, 0.3);
    }

    .card-img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        margin-bottom: 15px;
        border: 3px solid #555;
        object-fit: cover;
        background-color: #000;
    }

    .card-name {
        font-weight: bold;
        color: #e0aaff;
        font-size: 1.1em;
        text-transform: capitalize;
    }

    /* ESTILO DO BOTÃO DE CRIAR NOVO */
    .card-novo {
        border: 2px dashed #555;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        color: #555;
    }
    .card-novo:hover {
        border-color: #00ff00;
        color: #00ff00;
        background: rgba(0, 255, 0, 0.05);
    }
    .plus-icon { font-size: 50px; line-height: 50px; margin-bottom: 10px; }

    /* ESTILO DO BOTÃO DE DELETAR (X) */
    .btn-delete {
        position: absolute;
        top: 5px;
        right: 5px;
        background: transparent;
        border: none;
        color: #555;
        font-weight: bold;
        font-size: 16px;
        cursor: pointer;
        z-index: 10;
        padding: 5px 8px;
        border-radius: 4px;
    }
    .btn-delete:hover {
        background: #ff0000;
        color: white;
    }

    .img-loading { opacity: 0.5; filter: grayscale(100%); }
    .img-loaded { opacity: 1; filter: none; transition: opacity 0.5s ease; }
  </style>
</head>
<body>

  <header>
    <nav class="navbar">
      <div class="nav-links">
        <a href="#" onclick="alert('Você já está no painel.')">Personagem</a>
        <a href="#" class="active">Painel do Mestre</a>
      </div>
      <img src="img/imagem-no-site/perfil.png" alt="perfil" class="perfil-img" />
    </nav>
  </header>

  <h2 style="text-align:center; margin-top:40px; color:#9c27b0;">GERENCIAR FICHAS</h2>

  <div id="lista-personagens" class="grid-personagens">
    <p style="color:#666;">Carregando fichas...</p>
  </div>

  <script>
    const API_URL = 'https://dandd-chan.onrender.com/api'; 
    // ATENÇÃO: Se estiver testando localmente, mude para 'http://localhost:3000/api'

    window.onload = carregarLista;

    async function carregarLista() {
        const container = document.getElementById('lista-personagens');
        container.innerHTML = '<p style="color:#666;">Atualizando...</p>';

        try {
            const response = await fetch(`${API_URL}/lista-personagens`);
            const nomes = await response.json();
            
            container.innerHTML = ''; 

            // 1. ADICIONA O BOTÃO DE "CRIAR NOVO" PRIMEIRO
            const cardNovo = document.createElement('div');
            cardNovo.className = 'card-personagem card-novo';
            cardNovo.onclick = criarPersonagem;
            cardNovo.innerHTML = `
                <div class="plus-icon">+</div>
                <div>Nova Ficha</div>
            `;
            container.appendChild(cardNovo);

            // 2. LISTA OS PERSONAGENS EXISTENTES
            if(nomes.length > 0) {
                nomes.forEach(nome => {
                    const card = document.createElement('div');
                    card.className = 'card-personagem';
                    
                    const imgId = `img-card-${nome.replace(/\s+/g, '-')}`;

                    card.innerHTML = `
                        <button class="btn-delete" title="Apagar Ficha" onclick="deletarPersonagem(event, '${nome}')">✕</button>
                        <img id="${imgId}" src="img/imagem-no-site/personagem.png" class="card-img img-loading" alt="${nome}">
                        <div class="card-name">${nome}</div>
                    `;

                    // Clique na imagem ou no texto abre a ficha
                    card.onclick = (e) => {
                        // Se clicou no botão de deletar, não abre a ficha
                        if(e.target.classList.contains('btn-delete')) return;
                        abrirFichaDoJogador(nome);
                    };

                    container.appendChild(card);
                    carregarFotoIndividual(nome, imgId);
                });
            }

        } catch (error) {
            console.error(error);
            container.innerHTML = '<p style="color:red">Erro ao conectar com o servidor.</p>';
        }
    };

    // --- FUNÇÃO DE CRIAR ---
    async function criarPersonagem() {
        const nome = prompt("Nome do novo personagem:");
        if(!nome) return;
        const senha = prompt("Senha para o jogador:");
        if(!senha) return;

        try {
            const res = await fetch(`${API_URL}/criar-ficha`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ nome, senha })
            });

            const data = await res.json();

            if(res.ok) {
                alert("Personagem criado!");
                carregarLista(); // Atualiza a tela
            } else {
                alert("Erro: " + data.error);
            }
        } catch(e) {
            alert("Erro de conexão.");
        }
    }

    // --- FUNÇÃO DE DELETAR ---
    async function deletarPersonagem(event, nome) {
        event.stopPropagation(); // Impede de abrir a ficha ao clicar no X

        const confirmacao = confirm(`Tem certeza que deseja apagar a ficha de: ${nome}?\nIsso não pode ser desfeito.`);
        if(!confirmacao) return;

        try {
            const res = await fetch(`${API_URL}/deletar-ficha`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ nome })
            });

            if(res.ok) {
                carregarLista(); // Atualiza a tela
            } else {
                alert("Erro ao deletar.");
            }
        } catch(e) {
            alert("Erro de conexão.");
        }
    }

    async function carregarFotoIndividual(nome, imgId) {
        try {
            const res = await fetch(`${API_URL}/load-ficha-mestre`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ nome: nome })
            });
            if (res.ok) {
                const data = await res.json();
                const imgElement = document.getElementById(imgId);
                if (imgElement && data.fotoPerfil && data.fotoPerfil.length > 50) {
                    imgElement.src = data.fotoPerfil;
                    imgElement.classList.remove('img-loading');
                    imgElement.classList.add('img-loaded');
                }
            }
        } catch (e) { console.error(e); }
    }

    function abrirFichaDoJogador(nome) {
        window.open(`index.html?masterView=${nome}`, '_blank');
    }
  </script>
</body>
</html>