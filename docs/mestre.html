<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel do Mestre - Gerenciamento</title>
    <link rel="stylesheet" href="CSS/style.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    
    <style>
        /* --- ESTILOS GERAIS --- */
        body {
            background-color: #0a0a0a;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        /* --- NAVBAR --- */
        .navbar {
            display: flex;
            justify-content: space-between;
            padding: 15px 30px;
            background: #1a1a1a;
            align-items: center;
            border-bottom: 1px solid #333;
        }

        .nav-links a {
            color: #aaa;
            text-decoration: none;
            margin-right: 20px;
            font-weight: bold;
        }

        .nav-links a.active {
            color: #9c27b0;
        }

        .perfil-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #9c27b0;
        }

        /* --- √ÅREA DE TRABALHO (PASTAS) --- */
        #area-trabalho {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            padding: 20px 40px;
            overflow-x: auto;
            /* Permite rolar para o lado */
            height: calc(100vh - 100px);
            /* Altura total menos header */
            box-sizing: border-box;
        }

        /* Scrollbar estilizada */
        #area-trabalho::-webkit-scrollbar {
            height: 12px;
        }

        #area-trabalho::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        #area-trabalho::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 6px;
        }

        #area-trabalho::-webkit-scrollbar-thumb:hover {
            background: #9c27b0;
        }

        /* --- COLUNA / PASTA --- */
        .folder-container {
            background: #161616;
            border: 1px solid #333;
            border-radius: 8px;
            min-width: 280px;
            max-width: 280px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .folder-header {
            background: #1f1f1f;
            padding: 12px 15px;
            border-bottom: 2px solid #9c27b0;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #e0aaff;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 1px;
        }

        .btn-del-folder {
            background: none;
            border: none;
            color: #555;
            cursor: pointer;
            font-size: 1.1em;
            transition: 0.2s;
        }

        .btn-del-folder:hover {
            color: #ff4444;
        }

        .folder-content {
            padding: 10px;
            flex-grow: 1;
            overflow-y: auto;
            /* Scroll vertical dentro da pasta */
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 50px;
            /* √Årea m√≠nima para dropar */
        }

        .folder-content::-webkit-scrollbar {
            width: 6px;
        }

        .folder-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        /* --- CARD DO PERSONAGEM (Vers√£o Lista) --- */
        .card-personagem {
            background: #252525;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: grab;
            transition: transform 0.2s, border-color 0.2s;
            position: relative;
        }

        .card-personagem:active {
            cursor: grabbing;
        }

        .card-personagem:hover {
            border-color: #9c27b0;
            background: #2a2a2a;
            transform: translateY(-2px);
        }

        .card-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #555;
            object-fit: cover;
            background: #000;
            flex-shrink: 0;
        }

        .card-name {
            font-weight: bold;
            color: #e0aaff;
            font-size: 0.95em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
        }

        /* --- BOT√ÉO DE CRIAR NOVO (Dentro da lista) --- */
        .card-novo {
            background: rgba(156, 39, 176, 0.1);
            border: 1px dashed #9c27b0;
            justify-content: center;
            color: #9c27b0;
            font-weight: bold;
            cursor: pointer;
        }

        .card-novo:hover {
            background: rgba(156, 39, 176, 0.2);
        }

        /* --- BOT√ïES DE A√á√ÉO (Deletar e Editar dentro do card) --- */
        .btn-action {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: #666;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn-edit:hover {
            color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        .btn-delete:hover {
            color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
        }

        .img-loading {
            opacity: 0.5;
            filter: grayscale(100%);
        }

        .img-loaded {
            opacity: 1;
            filter: none;
            transition: opacity 0.5s ease;
        }

        /* --- BOT√ÉO FLUTUANTE PARA CRIAR PASTA --- */
        .btn-nova-pasta {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #9c27b0;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 30px;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .btn-nova-pasta:hover {
            transform: scale(1.1);
            background: #ba68c8;
        }

        /* --- MODAIS (Estilo Dark) --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .modal-box {
            background: #1a1a1a;
            border: 2px solid #9c27b0;
            border-radius: 10px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 0 20px rgba(156, 39, 176, 0.2);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-titulo {
            color: #e0aaff;
            margin-bottom: 20px;
            font-size: 1.5em;
            text-transform: uppercase;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: #000;
            border: 1px solid #333;
            color: white;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }

        .modal-input:focus {
            border-color: #9c27b0;
            outline: none;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
        }

        .btn-modal {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            flex: 1;
        }

        .btn-confirmar {
            background: #9c27b0;
            color: white;
        }

        .btn-confirmar:hover {
            background: #7b1fa2;
        }

        .btn-cancelar {
            background: #333;
            color: white;
        }

        .btn-cancelar:hover {
            background: #555;
        }

        .btn-perigo {
            background: #d32f2f;
            color: white;
        }

        .btn-perigo:hover {
            background: #b71c1c;
        }

        /* TOAST */
        .custom-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1a1a1a;
            color: #fff;
            border: 1px solid #9c27b0;
            border-radius: 6px;
            padding: 15px 20px;
            z-index: 10000;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                top: -20px;
            }

            to {
                opacity: 1;
                top: 20px;
            }
        }
    </style>
</head>

<body>

    <header>
        <nav class="navbar">
            <div class="nav-links">
                <a href="#" onclick="mostrarAviso('Voc√™ j√° est√° no painel.')">Personagem</a>
                <a href="#" class="active">Painel do Mestre</a>
            </div>
            <img src="img/imagem-no-site/perfil.png" alt="perfil" class="perfil-img" />
        </nav>
    </header>

    <div id="area-trabalho">
        <p style="color:#666; margin:auto;">Carregando sistema...</p>
    </div>

    <button class="btn-nova-pasta" onclick="abrirModalNovaPasta()" title="Criar Nova Pasta">+</button>


    <div id="modal-criar" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-titulo">Nova Ficha</h3>
            <p style="color:#aaa; font-size:0.9em; margin-bottom:15px;">Crie um novo her√≥i para a aventura.</p>
            <input type="text" id="novo-nome" class="modal-input" placeholder="Nome do Personagem" autocomplete="off">
            <input type="password" id="novo-senha" class="modal-input" placeholder="Senha do Jogador"
                autocomplete="off">
            <div class="modal-buttons">
                <button class="btn-modal btn-cancelar" onclick="fecharModalCriar()">Cancelar</button>
                <button class="btn-modal btn-confirmar" onclick="confirmarCriacao()">Criar Ficha</button>
            </div>
        </div>
    </div>

    <div id="modal-deletar" class="modal-overlay">
        <div class="modal-box" style="border-color: #d32f2f;">
            <h3 class="modal-titulo" style="color: #ef5350;">Apagar Ficha?</h3>
            <p style="color:#ddd; margin-bottom:20px;">
                Tem certeza que deseja excluir
                <strong id="nome-para-deletar" style="color: #e0aaff;"></strong>?
            </p>
            <div class="modal-buttons">
                <button class="btn-modal btn-cancelar" onclick="fecharModalDeletar()">Cancelar</button>
                <button class="btn-modal btn-perigo" onclick="confirmarDelecao()">Sim, Apagar</button>
            </div>
        </div>
    </div>

    <div id="modal-editar" class="modal-overlay">
        <div class="modal-box" style="border-color: #2196F3;">
            <h3 class="modal-titulo" style="color: #2196F3;">Editar Conta</h3>
            <p style="color:#aaa; font-size:0.9em; margin-bottom:15px;">
                Alterar acesso de: <strong id="nome-antigo-display" style="color:white;"></strong>
            </p>
            <label style="color: #bbb; display:block; text-align:left; margin-bottom:5px;">Novo Nome:</label>
            <input type="text" id="edit-nome" class="modal-input" placeholder="Novo Nome" autocomplete="off">
            <label style="color: #bbb; display:block; text-align:left; margin-bottom:5px;">Nova Senha:</label>
            <input type="text" id="edit-senha" class="modal-input" placeholder="Nova Senha" autocomplete="off">
            <div class="modal-buttons">
                <button class="btn-modal btn-cancelar" onclick="fecharModalEditar()">Cancelar</button>
                <button class="btn-modal btn-confirmar" style="background:#2196F3;"
                    onclick="confirmarEdicao()">Salvar</button>
            </div>
        </div>
    </div>

    <div id="modal-nova-pasta" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-titulo">Nova Pasta</h3>
            <p style="color:#aaa; font-size:0.9em; margin-bottom:15px;">Organize suas fichas em grupos.</p>
            <input type="text" id="nome-nova-pasta" class="modal-input" placeholder="Nome da Pasta (Ex: NPCs, Party)"
                autocomplete="off">
            <div class="modal-buttons">
                <button class="btn-modal btn-cancelar"
                    onclick="document.getElementById('modal-nova-pasta').style.display='none'">Cancelar</button>
                <button class="btn-modal btn-confirmar" onclick="confirmarNovaPasta()">Criar Pasta</button>
            </div>
        </div>
    </div>

    <div id="modal-deletar-pasta" class="modal-overlay">
        <div class="modal-box" style="border-color: #d32f2f;">
            <h3 class="modal-titulo" style="color: #ef5350;">Apagar Pasta?</h3>
            <p style="color:#ddd; margin-bottom:20px;">
                As fichas dentro dela voltar√£o para a lista "Sem Grupo".
            </p>
            <div class="modal-buttons">
                <button class="btn-modal btn-cancelar"
                    onclick="document.getElementById('modal-deletar-pasta').style.display='none'">Cancelar</button>
                <button class="btn-modal btn-perigo" onclick="confirmarDelecaoPasta()">Apagar Pasta</button>
            </div>
        </div>
    </div>

    <div id="modal-add-init" class="modal-overlay">
      <div class="modal-box" style="width: 350px;">
          <h3 class="modal-titulo">Adicionar Criatura</h3>
          
          <div style="display:flex; justify-content:center; margin-bottom:15px;">
              <div style="width:80px; height:80px; border-radius:50%; border:2px dashed #444; overflow:hidden; position:relative; cursor:pointer;" onclick="document.getElementById('manual-init-file').click()">
                  <img id="manual-init-preview" src="img/imagem-no-site/dado.png" style="width:100%; height:100%; object-fit:cover;">
                  <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.6); font-size:10px; color:#fff;">Alterar</div>
              </div>
              <input type="file" id="manual-init-file" accept="image/*" style="display:none;" onchange="previewManualInitImage(this)">
          </div>

          <input type="text" id="manual-init-name" class="modal-input" placeholder="Nome (Ex: Goblin 1)" autocomplete="off">
          <input type="number" id="manual-init-val" class="modal-input" placeholder="Valor de Iniciativa" autocomplete="off">
          
          <div class="modal-buttons">
              <button class="btn-modal btn-cancelar" onclick="fecharModalInit()">Cancelar</button>
              <button class="btn-modal btn-confirmar" onclick="confirmarAddInit()">Adicionar</button>
          </div>
      </div>
  </div>

        <script>
            const API_URL = 'https://dandd-chan.onrender.com/api';
            // const API_URL = 'http://localhost:3000/api'; // Teste Local

            // ADICIONE ESTA LINHA: Inicia o socket globalmente no painel do mestre
            window.socket = io('https://dandd-chan.onrender.com');
            let nomeDelecaoPendente = '';
            let nomeEdicaoPendente = '';
            let pastaIdDelecaoPendente = '';

            // --- FUN√á√ïES DO MODAL DE INICIATIVA MANUAL ---
        let currentInitImage = 'img/imagem-no-site/dado.png';

        function fecharModalInit() {
            document.getElementById('modal-add-init').style.display = 'none';
            document.getElementById('manual-init-name').value = '';
            document.getElementById('manual-init-val').value = '';
            document.getElementById('manual-init-preview').src = 'img/imagem-no-site/dado.png';
            currentInitImage = 'img/imagem-no-site/dado.png';
        }

        function previewManualInitImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('manual-init-preview').src = e.target.result;
                    currentInitImage = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // Suporte a Paste no Modal de Iniciativa
        document.addEventListener('paste', function(e) {
            if (document.getElementById('modal-add-init').style.display === 'flex') {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file' && item.type.includes('image/')) {
                        const blob = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            document.getElementById('manual-init-preview').src = event.target.result;
                            currentInitImage = event.target.result;
                        };
                        reader.readAsDataURL(blob);
                        e.preventDefault(); 
                    }
                }
            }
        });

        async function confirmarAddInit() {
            const nome = document.getElementById('manual-init-name').value.trim();
            const val = parseInt(document.getElementById('manual-init-val').value) || 0;
            
            if (nome) {
                // Usa o socket global (definido ou importado)
                if (!window.socket) window.socket = io('https://dandd-chan.onrender.com');

                window.socket.emit('add_to_tracker', {
                    id: Date.now(),
                    name: nome,
                    val: val,
                    img: currentInitImage
                });
                fecharModalInit();
            } else {
                mostrarAviso("Nome √© obrigat√≥rio.");
            }
        }

            // DADOS GLOBAIS
            let layoutAtual = { folders: [], uncategorized: [] };
            let todosPersonagens = [];

            // --- OBJETO DE PER√çCIAS PADR√ÉO (CORRE√á√ÉO AQUI) ---
            const PERICIAS_PADRAO = {
                "Atletismo": { "atributo": "FOR", "treinado": false, "outros": 0 },
                "Acrobacia": { "atributo": "DEX", "treinado": false, "outros": 0 },
                "Furtividade": { "atributo": "DEX", "treinado": false, "outros": 0 },
                "Prestidigita√ß√£o": { "atributo": "DEX", "treinado": false, "outros": 0 },
                "Arcanismo": { "atributo": "INT", "treinado": false, "outros": 0 },
                "Hist√≥ria": { "atributo": "INT", "treinado": false, "outros": 0 },
                "Investiga√ß√£o": { "atributo": "INT", "treinado": false, "outros": 0 },
                "Natureza": { "atributo": "INT", "treinado": false, "outros": 0 },
                "Religi√£o": { "atributo": "INT", "treinado": false, "outros": 0 },
                "Intui√ß√£o": { "atributo": "SAB", "treinado": false, "outros": 0 },
                "Lidar com animais": { "atributo": "SAB", "treinado": false, "outros": 0 },
                "Medicina": { "atributo": "SAB", "treinado": false, "outros": 0 },
                "Percep√ß√£o": { "atributo": "SAB", "treinado": false, "outros": 0 },
                "Sobreviv√™ncia": { "atributo": "SAB", "treinado": false, "outros": 0 },
                "Atua√ß√£o": { "atributo": "CAR", "treinado": false, "outros": 0 },
                "Engana√ß√£o": { "atributo": "CAR", "treinado": false, "outros": 0 },
                "Intimida√ß√£o": { "atributo": "CAR", "treinado": false, "outros": 0 },
                "Persuas√£o": { "atributo": "CAR", "treinado": false, "outros": 0 },

                // Salvaguardas
                "Salvaguarda (For√ßa)": { "atributo": "FOR", "treinado": false, "outros": 0 },
                "Salvaguarda (Destreza)": { "atributo": "DEX", "treinado": false, "outros": 0 },
                "Salvaguarda (Constitui√ß√£o)": { "atributo": "CON", "treinado": false, "outros": 0 },
                "Salvaguarda (Intelig√™ncia)": { "atributo": "INT", "treinado": false, "outros": 0 },
                "Salvaguarda (Sabedoria)": { "atributo": "SAB", "treinado": false, "outros": 0 },
                "Salvaguarda (Carisma)": { "atributo": "CAR", "treinado": false, "outros": 0 }
            };

            window.onload = carregarLista;

            // --- CARREGAMENTO INICIAL ---
            async function carregarLista() {
                const container = document.getElementById('area-trabalho');

                try {
                    // 1. Busca todos os nomes de personagens
                    const resChars = await fetch(`${API_URL}/lista-personagens`);
                    todosPersonagens = await resChars.json();

                    // 2. Busca o layout (pastas)
                    const resLayout = await fetch(`${API_URL}/layout`);
                    layoutAtual = await resLayout.json();

                    renderizarAreaTrabalho();
                } catch (error) {
                    console.error(error);
                    container.innerHTML = '<p style="color:red; margin:auto;">Erro ao conectar com servidor.</p>';
                }
            };

            // --- RENDERIZAR O KANBAN (PASTAS) ---
            function renderizarAreaTrabalho() {
                const container = document.getElementById('area-trabalho');
                container.innerHTML = '';

                // Filtrar personagens que n√£o est√£o em nenhuma pasta
                let charsNoLayout = new Set([...layoutAtual.uncategorized]);
                layoutAtual.folders.forEach(f => f.items.forEach(i => charsNoLayout.add(i)));

                todosPersonagens.forEach(nome => {
                    if (!charsNoLayout.has(nome)) {
                        layoutAtual.uncategorized.push(nome);
                    }
                });

                // 1. Renderiza a coluna "Sem Grupo" (Padr√£o)
                const divSemGrupo = criarElementoPasta('Sem Grupo', layoutAtual.uncategorized, 'uncategorized', false);
                container.appendChild(divSemGrupo);

                // 2. Renderiza as pastas criadas pelo usu√°rio
                layoutAtual.folders.forEach(pasta => {
                    const divPasta = criarElementoPasta(pasta.name, pasta.items, pasta.id, true);
                    container.appendChild(divPasta);
                });

                // Adiciona bot√£o de "Nova Ficha" no topo da lista Sem Grupo
                const pastaSemGrupoContent = divSemGrupo.querySelector('.folder-content');
                const btnNovoChar = document.createElement('div');
                btnNovoChar.className = 'card-personagem card-novo';
                btnNovoChar.innerHTML = '<div>+ Nova Ficha</div>';
                btnNovoChar.onclick = abrirModalCriar;

                // Insere no come√ßo
                pastaSemGrupoContent.insertBefore(btnNovoChar, pastaSemGrupoContent.firstChild);
            }

        
       
    function criarElementoPasta(titulo, itens, id, permiteDeletar) {
            const col = document.createElement('div');
            col.className = 'folder-container';
            col.dataset.id = id;

            // Cabe√ßalho
            const header = document.createElement('div');
            header.className = 'folder-header';
            header.innerHTML = `<span>${titulo}</span>`;
            
            if (permiteDeletar) {
                const btnDel = document.createElement('button');
                btnDel.className = 'btn-del-folder';
                btnDel.innerHTML = '‚úï'; 
                btnDel.title = 'Excluir Pasta';
                btnDel.onclick = () => abrirModalDeletarPasta(id);
                header.appendChild(btnDel);
            }
            col.appendChild(header);

            // Conte√∫do
            const content = document.createElement('div');
            content.className = 'folder-content';
            
            itens.forEach(nome => {
                if (todosPersonagens.includes(nome)) {
                    const card = criarCardHTML(nome);
                    content.appendChild(card);
                }
            });
            col.appendChild(content);

            new Sortable(content, {
                group: 'shared', animation: 150, ghostClass: 'img-loading', delay: 100, delayOnTouchOnly: true,
                onEnd: function (evt) { salvarNovoLayout(); }
            });

            // --- RODAP√â COM BOT√ïES ---
            const footer = document.createElement('div');
            footer.style.cssText = `
                padding: 8px;
                background: #1a1a1a;
                border-top: 1px solid #333;
                border-radius: 0 0 8px 8px;
                display: flex;
                flex-direction: column;
                gap: 6px;
            `;

            // 1. Bot√£o Principal (Abre Web)
            const btnObs = document.createElement('button');
            btnObs.innerHTML = "üé• Iniciativa (Web)";
            btnObs.style.cssText = `
                width: 100%; padding: 6px; background: linear-gradient(45deg, #1f1f1f, #2a2a2a);
                border: 1px solid #9c27b0; color: #e0aaff; border-radius: 4px;
                font-weight: bold; cursor: pointer; font-size: 11px; text-transform: uppercase;
            `;
            btnObs.onclick = () => {
                const cards = content.querySelectorAll('.card-personagem');
                const nomesMembros = Array.from(cards).map(c => c.dataset.nome).join(',');
                window.open(
                    `iniciativa.html?grupo=${encodeURIComponent(titulo)}&membros=${encodeURIComponent(nomesMembros)}&master=true`, 
                    '_blank'
                );
            };

            // 2. Container para bot√µes menores
            const rowSmallBtns = document.createElement('div');
            rowSmallBtns.style.cssText = "display: flex; gap: 4px;";

            // Bot√£o Add Manual
            const btnAdd = document.createElement('button');
            btnAdd.innerHTML = "‚ûï";
            btnAdd.title = "Adicionar criatura manualmente";
            btnAdd.style.cssText = "flex: 1; background: #222; border: 1px solid #444; color: #ccc; padding: 4px; font-size: 10px; cursor: pointer; border-radius: 4px;";
            btnAdd.onclick = () => {
                document.getElementById('modal-add-init').style.display = 'flex';
                document.getElementById('manual-init-name').focus();
            };

            // Bot√£o Limpar
            const btnClear = document.createElement('button');
            btnClear.innerHTML = "üóëÔ∏è";
            btnClear.title = "Limpar Iniciativa de Todos";
            btnClear.style.cssText = "width: 30px; background: #3a1a1a; border: 1px solid #b71c1c; color: #ff9999; padding: 4px; font-size: 10px; cursor: pointer; border-radius: 4px;";
            btnClear.onclick = () => {
                if (!window.socket) window.socket = io('https://dandd-chan.onrender.com');
                window.socket.emit('update_tracker', []);
            };

            rowSmallBtns.appendChild(btnAdd);
            rowSmallBtns.appendChild(btnClear);

            footer.appendChild(btnObs);
            footer.appendChild(rowSmallBtns);
            col.appendChild(footer);

            return col;
        }
            function criarCardHTML(nome) {
                const card = document.createElement('div');
                card.className = 'card-personagem';
                card.dataset.nome = nome;
                const imgId = `img-${nome.replace(/\s+/g, '-')}`;

                card.innerHTML = `
                <img id="${imgId}" src="img/imagem-no-site/personagem.png" class="card-img img-loading">
                <div class="card-name">${nome}</div>
                <button class="btn-action btn-edit" title="Editar" onclick="abrirModalEditar(event, '${nome}')">‚úé</button>
                <button class="btn-action btn-delete" title="Apagar" onclick="abrirModalDeletar(event, '${nome}')">‚úï</button>
            `;

                card.onclick = (e) => {
                    if (e.target.classList.contains('btn-action')) return;
                    abrirFichaDoJogador(nome);
                };

                carregarFotoIndividual(nome, imgId);
                return card;
            }

            // --- MANIPULA√á√ÉO DE DADOS (API) ---

            async function salvarNovoLayout() {
                const container = document.getElementById('area-trabalho');
                const pastasElements = container.querySelectorAll('.folder-container');

                const novoLayout = { folders: [], uncategorized: [] };

                pastasElements.forEach(pastaDiv => {
                    const id = pastaDiv.dataset.id;
                    const nomePasta = pastaDiv.querySelector('.folder-header span').innerText;

                    // Pega itens (ignorando o bot√£o "Nova Ficha")
                    const cards = pastaDiv.querySelectorAll('.card-personagem[data-nome]');
                    const nomes = Array.from(cards).map(c => c.dataset.nome);

                    if (id === 'uncategorized') {
                        novoLayout.uncategorized = nomes;
                    } else {
                        novoLayout.folders.push({
                            id: id,
                            name: nomePasta,
                            items: nomes
                        });
                    }
                });

                layoutAtual = novoLayout;

                // Envia para o servidor
                await fetch(`${API_URL}/save-layout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(novoLayout)
                });
            }

            // --- FUN√á√ïES DE PASTA ---

            function abrirModalNovaPasta() {
                document.getElementById('nome-nova-pasta').value = '';
                document.getElementById('modal-nova-pasta').style.display = 'flex';
                document.getElementById('nome-nova-pasta').focus();
            }

            async function confirmarNovaPasta() {
                const nome = document.getElementById('nome-nova-pasta').value.trim();
                if (!nome) {
                    mostrarAviso("Digite um nome para a pasta.");
                    return;
                }

                const novaPasta = {
                    id: 'folder-' + Date.now(),
                    name: nome,
                    items: []
                };

                layoutAtual.folders.push(novaPasta);
                document.getElementById('modal-nova-pasta').style.display = 'none'; // Fecha modal
                renderizarAreaTrabalho();
                salvarNovoLayout();
            }

            function abrirModalDeletarPasta(id) {
                pastaIdDelecaoPendente = id;
                document.getElementById('modal-deletar-pasta').style.display = 'flex';
            }

            async function confirmarDelecaoPasta() {
                if (!pastaIdDelecaoPendente) return;

                const pastaIndex = layoutAtual.folders.findIndex(f => f.id === pastaIdDelecaoPendente);
                if (pastaIndex > -1) {
                    const pasta = layoutAtual.folders[pastaIndex];
                    layoutAtual.uncategorized.push(...pasta.items); // Move itens
                    layoutAtual.folders.splice(pastaIndex, 1); // Remove pasta

                    renderizarAreaTrabalho();
                    salvarNovoLayout();
                }
                document.getElementById('modal-deletar-pasta').style.display = 'none'; // Fecha modal
                pastaIdDelecaoPendente = '';
            }

            // --- MODAIS E A√á√ïES DE FICHA ---

            function abrirModalCriar() {
                document.getElementById('novo-nome').value = '';
                document.getElementById('novo-senha').value = '';
                document.getElementById('modal-criar').style.display = 'flex';
                document.getElementById('novo-nome').focus();
            }
            function fecharModalCriar() { document.getElementById('modal-criar').style.display = 'none'; }

            // --- FUN√á√ÉO DE CRIA√á√ÉO ATUALIZADA COM O P√ÅDR√ÉO JSON ---
            async function confirmarCriacao() {
                const nome = document.getElementById('novo-nome').value.trim();
                const senha = document.getElementById('novo-senha').value.trim();

                if (!nome || !senha) return mostrarAviso("Preencha tudo!");

                // Monta o objeto completo para garantir que nada venha quebrado
                const novaFichaCompleta = {
                    nome: nome,
                    senha: senha,
                    fotoPerfil: "",
                    activeTab: "Invent√°rio",
                    atributos: { n1: 10, n2: 10, n3: 10, n4: 10, n5: 10, n6: 10 },
                    pericias: PERICIAS_PADRAO, // Usa a constante definida acima
                    niveisClasses: {},
                    xp: "0",
                    marco: 0,
                    vidaAtual: 1,
                    vidaTotalCalculada: 1,
                    inventory: [],
                    abilities: [],
                    spells: [],
                    description: {
                        anotacoes: "", aparencia: "", personalidade: "",
                        objetivo: "", ideais: "", vinculos: "", fraquezas: "", historia: ""
                    },
                    spellSlots: {
                        "1": { used: 0, status: [] }, "2": { used: 0, status: [] },
                        "3": { used: 0, status: [] }, "4": { used: 0, status: [] },
                        "5": { used: 0, status: [] }, "6": { used: 0, status: [] },
                        "7": { used: 0, status: [] }, "8": { used: 0, status: [] },
                        "9": { used: 0, status: [] }, "pact": { used: 0, status: [] },
                        "ki": { used: 0, status: [] }, "furia": { used: 0, status: [] },
                        "sorcery": { used: 0, status: [] }, "mutagen": { used: 0, status: [] }
                    }
                };

                try {
                    const res = await fetch(`${API_URL}/criar-ficha`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        // Envia a ficha completa em vez de apenas nome/senha
                        body: JSON.stringify(novaFichaCompleta)
                    });

                    if (res.ok) {
                        mostrarAviso("Criado com sucesso!");
                        fecharModalCriar();
                        carregarLista(); // Recarrega tudo
                    } else {
                        const d = await res.json();
                        mostrarAviso("Erro: " + d.error);
                    }
                } catch (e) {
                    console.error(e);
                    mostrarAviso("Erro de conex√£o.");
                }
            }

            function abrirModalDeletar(e, nome) {
                e.stopPropagation();
                nomeDelecaoPendente = nome;
                document.getElementById('nome-para-deletar').innerText = nome;
                document.getElementById('modal-deletar').style.display = 'flex';
            }
            function fecharModalDeletar() { document.getElementById('modal-deletar').style.display = 'none'; }

            async function confirmarDelecao() {
                if (!nomeDelecaoPendente) return;
                try {
                    const res = await fetch(`${API_URL}/deletar-ficha`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nome: nomeDelecaoPendente })
                    });
                    if (res.ok) {
                        mostrarAviso("Deletado.");
                        fecharModalDeletar();
                        carregarLista();
                    } else mostrarAviso("Erro ao deletar.");
                } catch (e) { mostrarAviso("Erro conexao"); }
            }

            async function abrirModalEditar(e, nome) {
                e.stopPropagation();
                nomeEdicaoPendente = nome;
                let senhaAtual = "";
                try {
                    const res = await fetch(`${API_URL}/load-ficha-mestre`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nome: nome })
                    });
                    if (res.ok) { const d = await res.json(); senhaAtual = d.senha || ""; }
                } catch (e) { }
                document.getElementById('nome-antigo-display').innerText = nome;
                document.getElementById('edit-nome').value = nome;
                document.getElementById('edit-senha').value = senhaAtual;
                document.getElementById('modal-editar').style.display = 'flex';
            }
            function fecharModalEditar() { document.getElementById('modal-editar').style.display = 'none'; }

            async function confirmarEdicao() {
                const novoNome = document.getElementById('edit-nome').value.trim();
                const novaSenha = document.getElementById('edit-senha').value.trim();
                if (!novoNome || !novaSenha) return mostrarAviso("Preencha tudo.");

                try {
                    const res = await fetch(`${API_URL}/editar-credenciais`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nomeAntigo: nomeEdicaoPendente, novoNome, novaSenha })
                    });
                    if (res.ok) {
                        mostrarAviso("Atualizado!");
                        fecharModalEditar();
                        carregarLista();
                    } else {
                        const d = await res.json();
                        mostrarAviso("Erro: " + d.error);
                    }
                } catch (e) { mostrarAviso("Erro conexao"); }
            }

            // --- UTILIT√ÅRIOS ---
            async function carregarFotoIndividual(nome, imgId) {
                try {
                    const res = await fetch(`${API_URL}/load-ficha-mestre`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nome: nome })
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const imgElement = document.getElementById(imgId);
                        if (imgElement && data.fotoPerfil && data.fotoPerfil.length > 50) {
                            imgElement.src = data.fotoPerfil;
                            imgElement.classList.remove('img-loading');
                            imgElement.classList.add('img-loaded');
                        }
                    }
                } catch (e) { }
            }

            function abrirFichaDoJogador(nome) {
                window.open(`index.html?masterView=${nome}`, '_blank');
            }

            function mostrarAviso(msg) {
                const div = document.createElement('div');
                div.className = 'custom-toast';
                div.innerText = msg;
                document.body.appendChild(div);
                setTimeout(() => div.remove(), 3000);
            }
        </script>
</body>

</html>