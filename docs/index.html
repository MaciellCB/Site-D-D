<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Herdeiros do Caos</title>

  <link rel="icon" type="image/png" href="img/imagem-no-site/logo.png" />

  <link rel="stylesheet" href="CSS/style.css" />
  <link rel="stylesheet" href="CSS/esquerdaCS.css">
  <link rel="stylesheet" href="CSS/direitaCS.css">
  <link rel="stylesheet" href="CSS/meioCS.css">
  <link rel="stylesheet" href="CSS/headerCS.css">

  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

  <style>
    /* CSS DO AVISO CUSTOMIZADO (TOAST) - Mantido inline para garantir carregamento */
    .custom-toast-warning {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #1a1a1a;
      color: #fff;
      border: 1px solid #9c27b0;
      border-radius: 6px;
      padding: 15px 20px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8);
      z-index: 200000;
      min-width: 300px;
      max-width: 90%;
      text-align: center;
      font-family: sans-serif;
      font-size: 14px;
      overflow: hidden;
      animation: toastSlideDown 0.3s ease-out forwards;
    }

    .toast-progress {
      position: absolute;
      top: 0;
      left: 0;
      height: 4px;
      background-color: #9c27b0;
      width: 100%;
      transition: width 5s linear;
    }

    .toast-content {
      margin-top: 5px;
      line-height: 1.4;
    }

    @keyframes toastSlideDown {
      from { top: -100px; opacity: 0; }
      to { top: 20px; opacity: 1; }
    }

    @keyframes toastFadeOut {
      from { opacity: 1; transform: translateX(-50%) scale(1); }
      to { opacity: 0; transform: translateX(-50%) scale(0.9); }
    }

    /* Link espec√≠fico para o Mestre voltar ao painel */
    .nav-mestre-link {
      display: none;
      color: #e0aaff;
      border-bottom: 1px dashed #e0aaff;
      cursor: pointer;
      font-size: 14px;
    }

    .nav-mestre-link:hover { color: #fff; }

    /* Estilo da Imagem Edit√°vel */
    .foto-personagem {
      cursor: pointer;
      transition: opacity 0.2s, transform 0.2s;
    }

    .foto-personagem:hover {
      opacity: 0.8;
      transform: scale(1.02);
      border: 2px solid #9c27b0;
    }

    /* =========================================================================
       CORRE√á√ÉO NUCLEAR V8 (PERFIL AJUSTADO MOBILE)
       ========================================================================= */
    @media (max-width: 768px) {
      
      /* 1. Estrutura Geral */
      body { 
        padding-bottom: 0 !important; 
        overflow-x: hidden !important; 
        background-color: #0a0a0a !important;
        overscroll-behavior-y: none !important; 
      }
      
      .container { 
        display: block !important; 
        padding: 0 !important; 
        width: 100vw !important; 
        overflow-x: hidden !important;
        min-height: auto !important; 
      }

      /* 2. Reseta os Pain√©is Laterais */
      .lado-direito, .lado-esquerdo, .lado-centro {
        width: 100vw !important;
        max-width: 100vw !important;
        min-width: 100vw !important;
        flex: none !important;
        margin: 0 !important;
        border: none !important;
        box-sizing: border-box !important;
        padding: 30px 15px 70px 15px !important; 
        position: relative !important;
        left: 0 !important;
        display: none !important;
        min-height: auto !important; 
      }

      /* 3. Corre√ß√£o espec√≠fica para a Ficha de Status */
      .ficha-compacta { margin-top: 10px !important; }

      /* 4. L√≥gica de Exibi√ß√£o (Header Separado) */
      header, .info-personagem { display: none !important; }

      /* === REGRAS DE ATIVA√á√ÉO PELO MENU INFERIOR === */
      
      /* ABA 1: PERFIL */
      body[data-mobile-view="header"] header { display: block !important; }
      body[data-mobile-view="header"] .info-personagem { 
        display: flex !important; 
        flex-direction: column !important;
        padding: 10px 15px 80px 15px !important;
        width: 100% !important;
        box-sizing: border-box !important;
        gap: 10px !important; 
      }
      body[data-mobile-view="header"] .info-esquerda {
        width: 100% !important; 
        display: flex !important; 
        justify-content: center !important; 
        margin-bottom: 10px !important; 
        margin-top: 0 !important;
      }
      body[data-mobile-view="header"] .info-direita, 
      body[data-mobile-view="header"] .linha-info,
      body[data-mobile-view="header"] .campo {
        width: 100% !important; 
        display: flex !important; 
        flex-direction: column !important;
        margin-bottom: 0 !important; 
      }
      body[data-mobile-view="header"] .campo {
          margin-bottom: 8px !important;
      }

      /* ABA 2: STATUS */
      body[data-mobile-view="status"] .lado-esquerdo { 
        display: flex !important; 
        flex-direction: column !important;
      }

      /* ABA 3: PER√çCIAS */
      body[data-mobile-view="pericia"] .lado-centro { 
        display: block !important; 
      }

      /* ABA 4: INVENT√ÅRIO/MAGIAS */
      body[data-mobile-view="inventario"] .lado-direito { 
        display: flex !important; 
        flex-direction: column !important; 
      }

      /* 5. EMPILHAMENTO DE ITENS */
      .inventory-list-wrapper, 
      .abilities-list, 
      .spells-list, 
      .inv-section-content, 
      .section-content,
      .conteudo {
        display: flex !important;
        flex-direction: column !important;
        flex-wrap: nowrap !important;
        width: 100% !important;
        gap: 10px !important;
        height: auto !important;
        padding-bottom: 0 !important; 
      }

      .card, .item-card, .hab-card, .spell-card {
        width: 100% !important;
        min-width: 100% !important;
        flex: 0 0 auto !important;
        margin: 0 0 10px 0 !important;
        box-sizing: border-box !important;
        white-space: normal !important;
      }

      .inv-section-group, .hab-section-group {
        width: 100% !important;
        display: block !important;
        margin-bottom: 20px !important;
      }

      /* Barra de pesquisa */
      .controls-row, .inventory-controls {
        display: flex !important;
        flex-direction: column !important;
        width: 100% !important;
        gap: 10px !important;
        margin-bottom: 15px !important;
      }
      .controls-row input, .inventory-controls input {
        width: 100% !important;
        height: 45px !important;
      }
      
      /* === MENU INFERIOR TRAVADO === */
      #mobile-navbar { 
        display: flex !important;
        position: fixed !important;
        bottom: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 60px !important;
        z-index: 2147483647 !important; 
        background-color: #0e0e0e !important;
        border-top: 1px solid #333 !important;
        box-sizing: border-box !important;
        overflow: hidden !important; 
        touch-action: none !important; 
        user-select: none !important;
        -webkit-user-select: none !important;
      }

      .mobile-nav-btn {
        flex: 1 !important; 
        min-width: 0 !important;
        height: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
        display: flex !important;
        flex-direction: column !important;
        justify-content: center !important;
        align-items: center !important;
        background: none !important;
        border: none !important;
        outline: none !important;
      }
      
      .mobile-nav-btn.active {
        background-color: #1a1a1a !important;
        border-top: 2px solid #9c27b0 !important;
      }
    }
  </style>
</head>

<body>
  <header>
    <nav class="navbar">
      <a href="#" class="logo-link" style="display: flex; align-items: center; text-decoration: none;">
         <img src="img/imagem-no-site/logo.png" alt="Logo" class="site-logo" />
      </a>

      <div class="nav-links">
        <a href="#" class="active">Personagem</a>
        <a href="mestre.html" id="link-voltar-painel" class="nav-mestre-link">Voltar ao Painel (Mestre)</a>
      </div>
    </nav>
  </header>

  <section class="info-personagem">
    <div class="info-esquerda">
      <div style="position: relative; display: inline-block;">
        <img src="img/imagem-no-site/personagem.png" alt="Foto do personagem" class="foto-personagem"
             id="img-personagem-visual" onclick="document.getElementById('input-foto-upload').click()"
             title="Clique para alterar a foto" />

        <button onclick="toggleConfigPopup(event)" class="btn-config-foto" title="Op√ß√µes da Ficha">
          ‚öôÔ∏è
        </button>

        <div id="popup-config-foto" class="popup-config-foto">
          <button onclick="abrirPortraitOBS()">
            üîó Abrir OBS <br>
            <span style="font-size: 10px; color: #888; font-weight: normal;">(Link para o navegador)</span>
          </button>
          
          <div style="height: 1px; background: #333; margin: 4px 0;"></div>
          
          <button onclick="toggleTracker()">‚öîÔ∏è Iniciativas</button>
          
          <button onclick="abrirHistoricoDados()">üé≤ Hist√≥rico de Dados</button>
          <button onclick="abrirAjudaSistema()">‚ùì Ajuda sobre Sistema</button>
        </div>
      </div>

      <input type="file" id="input-foto-upload" accept="image/*" style="display: none;" />
    </div>
    <div class="info-direita">
      <div class="linha-info">
        <div class="campo">
          <label>PERSONAGEM</label>
          <input type="text" id="input-personagem" placeholder="" />
        </div>
        <div class="campo">
          <label>JOGADOR</label>
          <input type="text" id="input-jogador" placeholder="" />
        </div>
        <div class="campo">
          <label>ALINHAMENTO</label>
          <div id="btn-alinhamento" class="input-simulado" tabindex="0">Escolher...</div>
        </div>
      </div>
      <div class="linha-info">
        <div class="campo">
          <label>ANTECEDENTE</label>
          <div id="btn-antecedente" class="input-simulado" tabindex="0">Escolher...</div>
        </div>
        <div class="campo">
          <label>CLASSE'S</label>
          <textarea id="input-classesHeader" class="header-textarea" rows="1" readonly></textarea>
        </div>
        <div class="campo">
          <label>RA√áA</label>
          <textarea id="input-raca" class="header-textarea" rows="1"></textarea>
        </div>
      </div>
    </div>
  </section>

  <main class="container">
    <section class="lado-esquerdo">
      <div class="atributos">
        <div class="atributos-header">
          <h3>Atributos</h3>
        </div>
        <div class="hexagrama">
          <img src="img/imagem-no-site/atributos.png" alt="Atributos" class="hex-overlay" />
          <span class="editar-hex">‚úèÔ∏è</span>
          <div class="num n1">10</div>
          <div class="num n2">10</div>
          <div class="num n3">10</div>
          <div class="num n4">10</div>
          <div class="num n5">10</div>
          <div class="num n6">10</div>
        </div>

        <div class="ficha-compacta">

          <div class="linha linha-top">
            <div class="nivel-destaque">
              <div class="nivel-titulo">N√çVEL</div>
              <div id="nivelFoco" class="nivel-valor">0</div>
            </div>

            <div class="status-row">
              <div class="status-item">
                <span class="status-label-top">Inspira√ß√£o</span>
                <div class="caixa-valor-controle">
                  <button class="btn-mini" id="inspiraLeft">‚óÄ</button>
                  <span id="inspiraValor" class="valor-grande">0</span>
                  <button class="btn-mini" id="inspiraRight">‚ñ∂</button>
                </div>
              </div>

              <div class="status-item">
                <span class="status-label-top"> Perc. Passiva</span>
                <div class="caixa-valor-fixo"> <span id="passivaValor" class="valor-grande">10</span>
                </div>
              </div>

              <div class="status-item">
                <span class="status-label-top">Profici√™ncia</span>
                <div class="caixa-valor-fixo">
                  <span id="proficienciaValor" class="valor-grande">2</span>
                </div>
              </div>
            </div>
          </div>

          <div class="linha linha-xp">
            <div class="xp-box">
              <div class="xp-top">
                <div style="display:flex;gap:8px;align-items:center;">
                  <span class="xp-label">XP</span>
                  <input id="xpAtual" type="number" min="0" value="0" class="xp-atual-input" />
                  <span id="xpTotalText" class="xp-total-text">/ 0</span>
                </div>
              </div>
              <div class="xp-bar-outer">
                <div class="xp-bar-inner" id="xpBar"></div>
              </div>
            </div>
            <div class="marco-box">
              <label>Marco</label>
              <div style="display:flex;gap:6px;align-items:center;">
                <input id="marcoAtual" type="number" min="0" value="0" class="marco-input" />
                <input id="marcoMax" type="number" readonly class="marco-input marco-max" />
              </div>
              <div class="marco-bar-outer">
                <div id="marcoBar" class="marco-bar-inner"></div>
              </div>
            </div>
          </div>

          <div class="linha linha-metros">
            <div class="metros-box">
              <label>Metros (m)</label>
              <input type="number" id="metros" min="0" value="0" />
            </div>

            <div class="quadrados-box">
              <label>Quadrados (q)</label>
              <input type="number" id="quadrados" min="0" step="1" />
            </div>

            <div class="dv-box">
              <label>D. Vida</label>
              <button id="btn-abrir-dv" class="btn-dv-trigger">
                <img src="img/imagem-no-site/dado.png" alt="DV">
              </button>
            </div>
          </div>

          <div class="vida-container">
            <h3 id="btnVida">VIDA</h3>
            <div class="vida-bar">
              <div class="vida-fill" id="vida-fill"></div>
              <div class="vida-text">
                <button class="vida-btn menos5">¬´</button>
                <button class="vida-btn menos1"><</button>
                    <span id="vida-atual">0</span>/<span id="vida-total">0</span>
                    <button class="vida-btn mais1">></button>
                    <button class="vida-btn mais5">¬ª</button>
              </div>
            </div>
            <div class="classes-lista-container" style="display:none; margin-top:8px;">
              <ul id="classesLista" style="list-style:none; padding:0; margin:0;"></ul>
            </div>
          </div>

          <div class="barras-secundarias">
            <div class="barra-secundaria">
              <h3>VIDA TEMPOR√ÅRIA</h3>
              <div class="vida-bar">
                <div class="vida-fill" id="vida-temp-fill"></div>
                <div class="vida-text">
                  <button class="vida-btn menos5">¬´</button>
                  <button class="vida-btn menos1"> < </button>
                      <span id="vida-temp-atual" contenteditable="true">0</span>
                      <button class="vida-btn mais1">></button>
                      <button class="vida-btn mais5">¬ª</button>
                </div>
              </div>
            </div>
            <div class="barra-secundaria">
              <h3>DANO NECR√ìTICO</h3>
              <div class="vida-bar">
                <div class="vida-fill" id="dano-necro-fill" style="background-color: purple;"></div>
                <div class="vida-text">
                  <button class="vida-btn menos5">¬´</button>
                  <button class="vida-btn menos1"><</button>
                      <span id="dano-necro-atual" contenteditable="true">0</span>
                      <button class="vida-btn mais1">></button>
                      <button class="vida-btn mais5">¬ª</button>
                </div>
              </div>
            </div>
          </div>

          <div class="armadura-area">
            <div class="armadura-card">
              <div class="armadura-grid">
                <div class="escudo-col">
                  <div class="escudo-wrap">
                    <img src="img/imagem-no-site/escudoArmad.png" alt="escudo" class="escudo-img" />
                    <div class="armadura-valor" id="armaduraValor">10</div>
                  </div>
                  <div class="iniciativa-block">
                    <div class="iniciativa-label">INICIATIVA</div>
                    <div class="iniciativa-valor" id="iniciativaValor">0</div>
                  </div>
                  <div class="bonus-iniciativa-block">
                    <span class="bonus-label">B√îNUS</span>
                    <input type="number" id="iniciativaBonus" class="bonus-valor" value="0" />
                  </div>
                  <button class="btn-rolar-iniciativa" id="btn-roll-ini" title="Rolar Iniciativa">
                    <img src="img/imagem-no-site/dado.png"> Rolar
                  </button>
                </div>

                <div class="formula-col">
                  <div class="armadura-titulo">CLASSE DE ARMADURA</div>
                  <div class="inline-formula">
                    <span class="formula-eq">=</span>
                    <span class="formula-text">10</span>
                    <span class="formula-plus">+</span>
                    <span class="formula-attr">Dex</span>
                    <span class="formula-plus">+</span>
                    <div class="zero-pair"><span class="zero-num">0</span><span class="zero-label">Equip.</span></div>
                    <span class="formula-plus">+</span>
                    <div class="zero-pair"><span class="zero-num" id="ac-outros" contenteditable="true">0</span><span
                        class="zero-label">Outros.</span></div>
                  </div>
                </div>
                <div class="tipo-col">
                  <div class="tipo-titulo">Tipo de armadura</div>
                  <div class="armadura-tag pesado">SEM ARMADURA</div>
                </div>
              </div>
              <div class="armadura-details">
                <div class="linha-detail">
                  <div class="label-detail">FRAQUEZA</div>
                  <div id="sel-fraquezas" class="input-detail"></div>
                </div>
                <div class="linha-detail">
                  <div class="label-detail">RESIST√äNCIAS</div>
                  <div id="sel-resistencias" class="input-detail"></div>
                </div>
                <div class="linha-detail">
                  <div class="label-detail">IMUNIDADE</div>
                  <div id="sel-imunidades" class="input-detail"></div>
                </div>
                <div class="linha-detail">
                  <div class="label-detail">PROFICI√äNCIAS</div>
                  <div id="sel-proficiencias" class="input-detail"></div>
                </div>
                <div class="linha-detail">
                  <div class="label-detail">IDIOMAS</div>
                  <div id="sel-idiomas" class="input-detail"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="lado-centro">
      <h3>Per√≠cias</h3>
      <ul class="pericias"></ul>
    </section>

    <section class="lado-direito">
      <div class="abas">
        <button class="ativa">Combate</button>
        <button>Mag. Preparadas</button>
        <button>Habilidades</button>
        <button>Invent√°rio</button>
        <button>Magias</button>
        <button>Descri√ß√£o</button>
      </div>
      <div class="conteudo">
        <p>Carregando...</p>
      </div>
    </section>
  </main>

  <div id="painelClasses" class="painel-classes" aria-hidden="true">
    <div class="painel-inner">
      <div class="painel-header">
        <h4>Classes</h4><button id="fecharPainel">‚úñ</button>
      </div>
      <div id="listaClasses" class="lista-classes"></div>
    </div>
  </div>

  <div id="painelDadosVida" class="painel-classes" style="z-index: 20001;" aria-hidden="true">
    <div class="painel-inner">
      <div class="painel-header" style="cursor: move;">
        <h4>Dados de Vida</h4>
        <button onclick="document.getElementById('painelDadosVida').style.display='none'">‚úñ</button>
      </div>
      <div id="listaDadosVida" class="lista-classes" style="padding-bottom:10px;">
      </div>
      <div
        style="font-size:11px; color:#777; text-align:center; margin-top:5px; border-top:1px solid #333; padding-top:5px;">
        Clique no dado para rolar e curar.<br>Mod. CON √© somado automatico.
      </div>
    </div>
  </div>

  <div id="login-overlay"
    style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:100000; display:flex; align-items:center; justify-content:center; font-family: sans-serif;">
    <div
      style="background:#1a1a1a; padding:40px; border-radius:12px; border:2px solid #9c27b0; text-align:center; width:320px;">
      <img src="img/imagem-no-site/dado-logo.png" style="width:120px; margin-bottom:20px; border-radius:50%; ">
      <h2 style="color:#fff; margin-bottom:25px; letter-spacing:1px;">ACESSO √Ä FICHA</h2>
      <input type="text" id="login-nome" placeholder="Nome do Personagem"
        style="width:100%; padding:12px; margin-bottom:15px; background:#000; color:#fff; border:1px solid #333; border-radius:4px;">
      <input type="password" id="login-senha" placeholder="Senha"
        style="width:100%; padding:12px; margin-bottom:25px; background:#000; color:#fff; border:1px solid #333; border-radius:4px;">
      <button onclick="tentarLogin()"
        style="background:#9c27b0; color:#fff; border:none; padding:12px; cursor:pointer; font-weight:bold; width:100%; border-radius:4px;">ENTRAR
        NA AVENTURA</button>
    </div>
  </div>

  <div id="modal-crop-overlay"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:999999; flex-direction:column; align-items:center; justify-content:center;">
    <div
      style="background:#1a1a1a; padding:20px; border-radius:10px; border:1px solid #9c27b0; width:90%; max-width:500px; max-height:90vh; display:flex; flex-direction:column;">
      <h3 style="color:#fff; margin-bottom:15px; text-align:center;">Ajustar Imagem</h3>

      <div style="width:100%; height:300px; background:#000; margin-bottom:20px; overflow:hidden;">
        <img id="imagem-para-crop" style="max-width:100%; display:block;">
      </div>

      <div style="display:flex; gap:10px; justify-content:center;">
        <button id="btn-cancelar-crop"
          style="background:#333; color:#fff; border:1px solid #555; padding:10px 20px; cursor:pointer; border-radius:4px;">Cancelar</button>
        <button id="btn-confirmar-crop"
          style="background:#9c27b0; color:#fff; border:none; padding:10px 20px; cursor:pointer; font-weight:bold; border-radius:4px;">Salvar
          Imagem</button>
      </div>
    </div>
  </div>

  <div id="tracker-overlay">
    <div class="tracker-header" id="tracker-handle">
        <span class="tracker-title">Rastreador</span>
        <button onclick="toggleTracker()" style="background:none; border:none; color:#fff; cursor:pointer;">‚úñ</button>
    </div>
    <div class="tracker-body">
        
        <div class="add-init-box">
            <div style="display:flex; flex-direction:column; gap:4px; flex:1;">
                <input type="text" id="new-mob-name" class="add-init-input" placeholder="Nome (Cole img aqui)">
                <input type="number" id="new-mob-val" class="add-init-input" placeholder="Valor">
            </div>
            <div style="display:flex; flex-direction:column; gap:4px;">
                <img id="new-mob-preview" src="img/imagem-no-site/dado.png" style="width:30px; height:30px; object-fit:cover; border-radius:4px; border:1px solid #555;">
                <button onclick="addMobToTracker()" class="btn-add" style="padding:4px; height:100%;">+</button>
            </div>
        </div>

        <div id="tracker-list" class="tracker-list">
            </div>
    </div>
    <div class="init-actions">
        <button onclick="limparTracker()" style="flex:1; background:#b71c1c; border:none; color:#fff; padding:6px; border-radius:4px; font-size:11px; cursor:pointer;">Limpar</button>
        <button onclick="sortTracker()" style="flex:1; background:#333; border:1px solid #555; color:#fff; padding:6px; border-radius:4px; font-size:11px; cursor:pointer;">Ordenar</button>
    </div>
  </div>

  <div id="mobile-navbar">
    <button class="mobile-nav-btn active" onclick="setMobileView('header')">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
      </svg>
      <span>Perfil</span>
    </button>

    <button class="mobile-nav-btn" onclick="setMobileView('status')">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
      </svg>
      <span>Status</span>
    </button>

    <button class="mobile-nav-btn" onclick="setMobileView('pericia')">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14l-5-5 1.41-1.41L12 14.17l7.59-7.59L21 8l-9 9z" />
      </svg>
      <span>Per√≠cias</span>
    </button>

    <button class="mobile-nav-btn" onclick="setMobileView('inventario')">
      <svg viewBox="0 0 24 24" fill="currentColor">
        <path d="M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z" />
      </svg>
      <span>Inv/Mag</span>
    </button>
  </div>

  <script src="JS/DireitaJS.js"></script>
  <script src="JS/EsquerdaJS.js"></script>
  <script src="JS/MeioJS.js"></script>
  <script src="JS/HeaderJS.js"></script>
  <script src="JS/MagicSystem.js"></script>

  <script>
    /* =================================================================
       L√ìGICA DO MODO MOBILE
       ================================================================= */
    function setMobileView(view) {
      document.body.setAttribute('data-mobile-view', view);
      document.querySelectorAll('.mobile-nav-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('onclick').includes(view)) {
          btn.classList.add('active');
        }
      });
      window.scrollTo(0, 0);
    }

    if (window.innerWidth <= 768) {
      setMobileView('status');
    }

    /* =================================================================
       L√ìGICA DO SOCKET.IO (SINCRONIZA√á√ÉO EM TEMPO REAL)
       ================================================================= */
    const socket = io('https://dandd-chan.onrender.com');

    socket.on('connect', () => {
      console.log("Conectado ao servidor de atualiza√ß√µes! ID:", socket.id);
    });

    socket.on('ficha_atualizada', (novaFicha) => {
      // Verifica se a ficha √© a mesma que est√° aberta
      if (state && state.nome && novaFicha.nome && novaFicha.nome.toLowerCase() === state.nome.toLowerCase()) {
        console.log("Recebi atualiza√ß√£o externa para: " + novaFicha.nome);

        // 1. Chama a fun√ß√£o de mesclagem que criamos no DireitaJS
        // Se a fun√ß√£o existir (carregada), usa ela. Se n√£o, usa o dado bruto.
        let estadoFinal = novaFicha;

        if (typeof window.mesclarEstadoVisual === 'function') {
          estadoFinal = window.mesclarEstadoVisual(state, novaFicha);
        }

        // 2. Atualiza o estado com os dados mesclados (Preservando abertas/fechadas)
        Object.assign(state, estadoFinal);

        // 3. Atualiza a tela
        if (typeof preencherFichaNaTela === 'function') preencherFichaNaTela(state);
        if (typeof atualizarHeader === 'function') atualizarHeader();
        if (typeof atualizarTextoClassesHeader === 'function') atualizarTextoClassesHeader();
        if (typeof inicializarDadosEsquerda === 'function') inicializarDadosEsquerda();
        if (typeof atualizarTudoVisual === 'function') atualizarTudoVisual();

        // Dispara evento para redesenhar a Direita
        window.dispatchEvent(new CustomEvent('sheet-updated'));
      }
    });

    /* =================================================================
       L√ìGICA DO MESTRE & PREENCHIMENTO DE DADOS
       ================================================================= */
    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      const masterChar = params.get('masterView');

      if (masterChar) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('link-voltar-painel').style.display = 'block';
        carregarFichaMestre(masterChar);
      }
    });

    async function carregarFichaMestre(nome) {
      try {
        const res = await fetch('https://dandd-chan.onrender.com/api/load-ficha-mestre', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nome: nome })
        });

        if (res.ok) {
          const ficha = await res.json();
          if (typeof state !== 'undefined') {
            Object.assign(state, ficha);
            preencherFichaNaTela(ficha);
            if (typeof inicializarDadosEsquerda === 'function') inicializarDadosEsquerda();
            if (typeof atualizarTudoVisual === 'function') atualizarTudoVisual();
            if (typeof atualizarHeader === 'function') atualizarHeader();
            window.dispatchEvent(new CustomEvent('sheet-updated'));
            if (typeof setActiveTab === 'function') setActiveTab(state.activeTab || 'Combate');
            exibirAvisoTemporario("Mestre: Visualizando " + ficha.nome);
          }
        } else {
          exibirAvisoTemporario("Erro: Personagem n√£o encontrado.");
        }
      } catch (e) {
        console.error(e);
        exibirAvisoTemporario("Erro de conex√£o com o servidor.");
      }
    }

    function preencherFichaNaTela(data) {
      // ALTERADO: Agora preenche o input com 'personagem' e s√≥ usa 'nome' se o outro estiver vazio
      setVal('input-personagem', data.personagem || data.nome);
      setVal('input-jogador', data.jogador);
      setVal('input-raca', data.raca);
      setTxt('btn-antecedente', data.antecedente);

      // Atualiza o HUD do OBS se estiver aberto (Nome Visual)
      const overlayNome = document.getElementById('nome-personagem-overlay');
      if (overlayNome) overlayNome.textContent = data.personagem || data.nome;

      const imgElement = document.getElementById('img-personagem-visual');
      if (imgElement) {
        imgElement.src = (data.fotoPerfil && data.fotoPerfil.length > 10) ? data.fotoPerfil : "img/imagem-no-site/personagem.png";
      }

      if (data.atributos) {
        setTxtQ('.num.n1', data.atributos.n1);
        setTxtQ('.num.n2', data.atributos.n2);
        setTxtQ('.num.n3', data.atributos.n3);
        setTxtQ('.num.n4', data.atributos.n4);
        setTxtQ('.num.n5', data.atributos.n5);
        setTxtQ('.num.n6', data.atributos.n6);
      }
    }

    function setVal(id, valor) { const el = document.getElementById(id); if (el) el.value = valor !== undefined ? valor : ''; }
    function setTxt(id, valor) { const el = document.getElementById(id); if (el) el.innerText = valor !== undefined ? valor : ''; }
    function setTxtQ(selector, valor) { const el = document.querySelector(selector); if (el) el.innerText = valor !== undefined ? valor : ''; }

    /* =================================================================
       SISTEMA DE LOGIN / TOASTS / ALERTAS
       ================================================================= */
    function exibirAvisoTemporario(mensagem) {
      const existente = document.querySelector('.custom-toast-warning');
      if (existente) existente.remove();

      const toast = document.createElement('div');
      toast.className = 'custom-toast-warning';

      const progress = document.createElement('div');
      progress.className = 'toast-progress';

      const content = document.createElement('div');
      content.className = 'toast-content';

      const textoFormatado = mensagem.split('\n').join('<br>');
      content.innerHTML = '<strong style="color:#e0aaff; display:block; margin-bottom:4px; font-size:11px; letter-spacing:1px;">SISTEMA</strong>' + textoFormatado;

      toast.appendChild(progress);
      toast.appendChild(content);
      document.body.appendChild(toast);

      setTimeout(() => { progress.style.width = '0%'; }, 50);
      setTimeout(() => {
        if (toast.parentElement) {
          toast.style.animation = 'toastFadeOut 0.5s ease-out forwards';
          setTimeout(() => toast.remove(), 450);
        }
      }, 5000);
    }

    window.alert = function (msg) { exibirAvisoTemporario(msg); };

    function tentarLogin() {
      const nome = document.getElementById('login-nome').value;
      const senha = document.getElementById('login-senha').value;

      if (nome.toLowerCase() === 'mestre' && senha === 'admin') {
        window.open('mestre.html', '_blank');
        document.getElementById('login-nome').value = '';
        document.getElementById('login-senha').value = '';
        exibirAvisoTemporario("Painel do Mestre aberto em nova aba.");
        return;
      }

      if (nome && senha) {
        if (typeof carregarDadosIniciais === 'function') {
          carregarDadosIniciais(nome, senha);
        } else {
          alert("Erro: Scripts JS n√£o carregados corretamente.");
        }
      } else {
        exibirAvisoTemporario("Preencha todos os campos!");
      }
    }

    /* =================================================================
       L√ìGICA DE RECORTE (CROP) E SALVAMENTO REORDENADO
       ================================================================= */

    // Fun√ß√£o auxiliar para garantir a ordem das chaves no JSON
    function reordenarObjeto(obj) {
      const chavesPrioritarias = ["nome", "senha", "fotoPerfil", "activeTab", "spellDCConfig", "dtMagias"];
      const novoObj = {};
      chavesPrioritarias.forEach(chave => {
        if (obj.hasOwnProperty(chave)) {
          novoObj[chave] = obj[chave];
        }
      });
      Object.keys(obj).forEach(chave => {
        if (!chavesPrioritarias.includes(chave)) {
          novoObj[chave] = obj[chave];
        }
      });
      return novoObj;
    }

    // Elementos do DOM
    const inputFoto = document.getElementById('input-foto-upload');
    const modalCrop = document.getElementById('modal-crop-overlay');
    const imgParaCrop = document.getElementById('imagem-para-crop');
    const btnConfirmarCrop = document.getElementById('btn-confirmar-crop');
    const btnCancelarCrop = document.getElementById('btn-cancelar-crop');
    const imgVisual = document.getElementById('img-personagem-visual');

    let cropper = null;

    if (inputFoto) {
      // 1. Ao selecionar arquivo, abre o modal
      inputFoto.addEventListener('change', function (e) {
        const files = e.target.files;
        if (files && files.length > 0) {
          const file = files[0];
          const url = URL.createObjectURL(file);

          imgParaCrop.src = url;
          modalCrop.style.display = 'flex'; // Exibe o modal

          if (cropper) cropper.destroy();

          cropper = new Cropper(imgParaCrop, {
            aspectRatio: 1, // For√ßa quadrado
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 1,
            restore: false,
            guides: true,
            center: true,
            highlight: false,
            cropBoxMovable: true,
            cropBoxResizable: true,
            toggleDragModeOnDblclick: false,
          });

          inputFoto.value = ''; // Limpa input para permitir re-sele√ß√£o
        }
      });

      // 2. Bot√£o Cancelar
      btnCancelarCrop.onclick = function () {
        modalCrop.style.display = 'none';
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
      };

      // 3. Bot√£o Salvar (Recortar e Enviar)
      btnConfirmarCrop.onclick = function () {
        if (!cropper) return;

        // Pega o resultado (300x300px)
        const canvas = cropper.getCroppedCanvas({
          width: 300,
          height: 300,
        });

        const imagemBase64 = canvas.toDataURL('image/jpeg', 0.85);

        // Atualiza na tela
        if (imgVisual) imgVisual.src = imagemBase64;

        // Fecha modal
        modalCrop.style.display = 'none';
        cropper.destroy();
        cropper = null;

        // Salva no State com Reordena√ß√£o
        if (typeof state !== 'undefined') {
          state.fotoPerfil = imagemBase64;

          const stateOrdenado = reordenarObjeto(state);
          Object.assign(state, stateOrdenado);

          console.log("Salvando foto recortada e reordenando JSON...");

          if (typeof saveStateToServer === 'function') {
            saveStateToServer();
          } else if (typeof socket !== 'undefined') {
            socket.emit('ficha_atualizada', stateOrdenado);
          }
        }
      };
    }


    /* =================================================================
            RECEBIMENTO DE DADOS ROLADOS (SINCRONIZA√á√ÉO VISUAL)
            ================================================================= */
    socket.on('dados_rolados', (data) => {
      // 1. Ignora se fui eu mesmo que enviei (pois j√° vi a anima√ß√£o localmente)
      if (data.socketId === socket.id) return;

      // 2. Verifica se √© para a ficha que estou aberto
      // (Compara o nome da ficha aberta com o nome da ficha que rolou o dado)
      if (state && state.nome && data.personagem &&
        data.personagem.toLowerCase() === state.nome.toLowerCase()) {

        console.log("Recebendo rolagem remota de outra tela...");

        // Chama a fun√ß√£o visual marcando como TRUE (√© remoto)
        // Isso exibe o popup mas impede que ele seja reenviado para o servidor
        if (typeof showCombatResults === 'function') {
          showCombatResults(data.titulo, data.ataque, data.dano, true);
        }
      }
    });


  </script>
</body>

</html>